{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="page-inner">
  <div class="page-header">
    <h4 class="page-title">{% if object %}Update Incident{% else %}Add Fire Incident{% endif %}</h4>
    <ul class="breadcrumbs">
      <li class="nav-home">
        <a href="{% url 'home' %}">
          <i class="flaticon-home"></i>
        </a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="{% url 'incident-list' %}">Incidents</a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="#">{% if object %}Edit{% else %}Add{% endif %}</a>
      </li>
    </ul>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Incident Details</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="incidentForm">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  {{ form.as_p }}
                </div>
              </div>
              <div class="col-md-6">
                <div class="weather-info mb-3">
                  <h5>Current Weather Conditions</h5>
                  <div id="weather-data" class="weather-container">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Loading weather data...</p>
                  </div>
                </div>
                <div id="map" style="width: 100%; height: 400px;" class="map-container">
                  <div class="loading-spinner"></div>
                </div>
                <input type="hidden" id="latitude" name="latitude" 
                       data-default="{{ object.location.latitude|default_if_none:'' }}"
                       value="{{ object.location.latitude|default_if_none:'' }}">
                <input type="hidden" id="longitude" name="longitude"
                       data-default="{{ object.location.longitude|default_if_none:'' }}"
                       value="{{ object.location.longitude|default_if_none:'' }}">
                <input type="hidden" id="temperature" name="temperature" value="{{ object.location.temperature|default_if_none:'' }}">
                <input type="hidden" id="humidity" name="humidity" value="{{ object.location.humidity|default_if_none:'' }}">
                <input type="hidden" id="wind_speed" name="wind_speed" value="{{ object.location.wind_speed|default_if_none:'' }}">
                <input type="hidden" id="weather_conditions" name="weather_conditions" value="{{ object.location.weather_conditions|default_if_none:'' }}">
              </div>
            </div>
            <div class="card-action">
              <button type="submit" class="btn btn-primary">Save</button>
              <a href="{% url 'incident-list' %}" class="btn btn-danger">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
  .card-action {
    padding-top: 20px;
    border-top: 1px solid #ebedf2;
    margin-top: 20px;
  }

  .loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 10px auto;
  }

  .weather-container, .map-container {
    position: relative;
    min-height: 100px;
  }

  .loading-text {
    text-align: center;
    color: #666;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Leaflet map initialization
    const map = L.map('map').setView([0, 0], 13);

    // Load OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
    }).addTo(map);

    const latitudeField = document.getElementById('latitude');
    const longitudeField = document.getElementById('longitude');
    
    // Update test location to Palawan coordinates
    const testLocation = {lat: 9.7348, lng: 118.7384}; // Puerto Princesa, Palawan coordinates
    const lat = parseFloat(latitudeField.value) || testLocation.lat;
    const lng = parseFloat(longitudeField.value) || testLocation.lng;

    const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
    map.setView([lat, lng], 13);

    // Add test location button
    const customControl = L.Control.extend({
      options: {
        position: 'topright'
      },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', '', container);
        button.innerHTML = 'Test Location';
        button.href = '#';
        button.style.width = 'auto';
        button.style.padding = '0 10px';
        
        L.DomEvent.on(button, 'click', function(e) {
          L.DomEvent.preventDefault(e);
          marker.setLatLng(testLocation);
          map.setView(testLocation, 13);
          latitudeField.value = testLocation.lat;
          longitudeField.value = testLocation.lng;
          fetchWeatherData(testLocation.lat, testLocation.lng);
        });
        
        return container;
      }
    });
    
    map.addControl(new customControl());

    // Weather Data Fetch Function
    async function fetchWeatherData(lat, lng) {
      const weatherDataEl = document.getElementById('weather-data');
      weatherDataEl.innerHTML = '<p>Loading weather data...</p>'; // Loading state
      try {
        const response = await fetch(`/api/weather/?lat=${lat}&lon=${lng}`);
        if (!response.ok) throw new Error('Failed to fetch weather data');
        const data = await response.json();

        // Update weather display
        weatherDataEl.innerHTML = `
          <p><strong>Temperature:</strong> ${data.temperature}Â°C</p>
          <p><strong>Humidity:</strong> ${data.humidity}%</p>
          <p><strong>Wind Speed:</strong> ${data.wind_speed} m/s</p>
          <p><strong>Conditions:</strong> ${data.conditions}</p>
        `;

        // Update hidden fields
        document.getElementById('temperature').value = data.temperature;
        document.getElementById('humidity').value = data.humidity;
        document.getElementById('wind_speed').value = data.wind_speed;
        document.getElementById('weather_conditions').value = data.conditions;
      } catch (error) {
        console.error('Weather Data Error:', error);
        weatherDataEl.innerHTML = `
          <p class="text-danger">Unable to load weather data. Please try again later.</p>
        `;
      }
    }

    // Fetch weather data when marker is moved
    marker.on('moveend', function (e) {
      const position = e.target.getLatLng();
      latitudeField.value = position.lat.toFixed(6);
      longitudeField.value = position.lng.toFixed(6);
      fetchWeatherData(position.lat, position.lng);
    });

    // Initial weather data fetch
    if (lat && lng) {
      fetchWeatherData(lat, lng);
    }
  });
</script>
{% endblock %}
